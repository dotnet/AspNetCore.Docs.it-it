---
title: 'Esercitazione: implementare la funzionalità CRUD-ASP.NET MVC con EF Core'
description: In questa esercitazione verrà esaminato e personalizzato il codice CRUD (Create, Read, Update, Delete) che lo scaffolding di MVC crea automaticamente nei controller e nelle visualizzazioni.
author: rick-anderson
ms.author: riande
ms.custom: mvc
ms.date: 02/04/2019
ms.topic: tutorial
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: data/ef-mvc/crud
ms.openlocfilehash: c3cfee107541a20a089809193d4bf7fa08730bd2
ms.sourcegitcommit: 54fe1ae5e7d068e27376d562183ef9ddc7afc432
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/10/2021
ms.locfileid: "102586397"
---
# <a name="tutorial-implement-crud-functionality---aspnet-mvc-with-ef-core"></a><span data-ttu-id="ee4e5-103">Esercitazione: implementare la funzionalità CRUD-ASP.NET MVC con EF Core</span><span class="sxs-lookup"><span data-stu-id="ee4e5-103">Tutorial: Implement CRUD Functionality - ASP.NET MVC with EF Core</span></span>

<span data-ttu-id="ee4e5-104">Nell'esercitazione precedente è stata creata un'applicazione MVC che memorizza e visualizza i dati usando Entity Framework e SQL Server LocalDB.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-104">In the previous tutorial, you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="ee4e5-105">In questa esercitazione verrà esaminato e personalizzato il codice CRUD (Create, Read, Update, Delete) che lo scaffolding di MVC crea automaticamente nei controller e nelle visualizzazioni.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-105">In this tutorial, you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE]
> <span data-ttu-id="ee4e5-106">È pratica comune implementare il modello di repository per creare un livello di astrazione tra il controller e il livello di accesso ai dati.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-106">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="ee4e5-107">Per mantenere le esercitazioni semplici e incentrate sulla descrizione dell'uso di Entity Framework, non vengono usati i repository.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-107">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="ee4e5-108">Per informazioni sui repository con EF, vedere l'[ultima esercitazione della serie](advanced.md).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-108">For information about repositories with EF, see [the last tutorial in this series](advanced.md).</span></span>

<span data-ttu-id="ee4e5-109">In questa esercitazione:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-109">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="ee4e5-110">Personalizzare la pagina Details</span><span class="sxs-lookup"><span data-stu-id="ee4e5-110">Customize the Details page</span></span>
> * <span data-ttu-id="ee4e5-111">Aggiornare la pagina Create</span><span class="sxs-lookup"><span data-stu-id="ee4e5-111">Update the Create page</span></span>
> * <span data-ttu-id="ee4e5-112">Aggiornare la pagina Edit (Modifica)</span><span class="sxs-lookup"><span data-stu-id="ee4e5-112">Update the Edit page</span></span>
> * <span data-ttu-id="ee4e5-113">Aggiornare la pagina Delete (Elimina)</span><span class="sxs-lookup"><span data-stu-id="ee4e5-113">Update the Delete page</span></span>
> * <span data-ttu-id="ee4e5-114">Chiudere le connessioni di database</span><span class="sxs-lookup"><span data-stu-id="ee4e5-114">Close database connections</span></span>

## <a name="prerequisites"></a><span data-ttu-id="ee4e5-115">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="ee4e5-115">Prerequisites</span></span>

* [<span data-ttu-id="ee4e5-116">Introduzione a EF Core e ASP.NET Core MVC</span><span class="sxs-lookup"><span data-stu-id="ee4e5-116">Get started with EF Core and ASP.NET Core MVC</span></span>](intro.md)

## <a name="customize-the-details-page"></a><span data-ttu-id="ee4e5-117">Personalizzare la pagina Details</span><span class="sxs-lookup"><span data-stu-id="ee4e5-117">Customize the Details page</span></span>

<span data-ttu-id="ee4e5-118">Il codice con scaffolding della pagina Students Index ha escluso la proprietà `Enrollments` poiché la proprietà contiene una raccolta.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-118">The scaffolded code for the Students Index page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="ee4e5-119">Nella pagina **Details** verranno visualizzati i contenuti della raccolta in una tabella HTML.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-119">In the **Details** page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="ee4e5-120">In *Controllers/StudentsController.cs* il metodo di azione per la visualizzazione Details usa il metodo `SingleOrDefaultAsync` per recuperare una singola entità `Student`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-120">In *Controllers/StudentsController.cs*, the action method for the Details view uses the `SingleOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="ee4e5-121">Aggiungere un codice che chiama i metodi `Include`,</span><span class="sxs-lookup"><span data-stu-id="ee4e5-121">Add code that calls `Include`.</span></span> <span data-ttu-id="ee4e5-122">`ThenInclude` e `AsNoTracking`, come illustrato nel codice evidenziato seguente.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-122">`ThenInclude`,  and `AsNoTracking` methods, as shown in the following highlighted code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]

<span data-ttu-id="ee4e5-123">I metodi `Include` e `ThenInclude` fanno in modo che il contesto carichi la proprietà di navigazione `Student.Enrollments` e la proprietà di navigazione `Enrollment.Course` all'interno di ogni registrazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-123">The `Include` and `ThenInclude` methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span>  <span data-ttu-id="ee4e5-124">Per altre informazioni su questi metodi, vedere l'esercitazione [Leggere dati correlati](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-124">You'll learn more about these methods in the [read related data](read-related-data.md) tutorial.</span></span>

<span data-ttu-id="ee4e5-125">Il metodo `AsNoTracking` migliora le prestazioni negli scenari in cui le entità restituite non vengono aggiornate nel contesto corrente.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-125">The `AsNoTracking` method improves performance in scenarios where the entities returned won't be updated in the current context's lifetime.</span></span> <span data-ttu-id="ee4e5-126">Altre informazioni su `AsNoTracking` sono disponibili alla fine di questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-126">You'll learn more about `AsNoTracking` at the end of this tutorial.</span></span>

### <a name="route-data"></a><span data-ttu-id="ee4e5-127">Indirizzare i dati</span><span class="sxs-lookup"><span data-stu-id="ee4e5-127">Route data</span></span>

<span data-ttu-id="ee4e5-128">Il valore della chiave passato al metodo `Details` deriva dai *dati della route*.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-128">The key value that's passed to the `Details` method comes from *route data*.</span></span> <span data-ttu-id="ee4e5-129">I dati della route sono i dati trovati dallo strumento di associazione di modelli in un segmento dell'URL.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-129">Route data is data that the model binder found in a segment of the URL.</span></span> <span data-ttu-id="ee4e5-130">Ad esempio, la route predefinita specifica i segmenti del controller, dell'azione e dell'ID:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-130">For example, the default route specifies controller, action, and id segments:</span></span>

[!code-csharp[](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]

<span data-ttu-id="ee4e5-131">Nell'URL seguente la route predefinita mappa Instructor come controller, Index come azione e 1 come ID: questi sono i valori dei dati della route.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-131">In the following URL, the default route maps Instructor as the controller, Index as the action, and 1 as the id; these are route data values.</span></span>

```
http://localhost:1230/Instructor/Index/1?courseID=2021
```

<span data-ttu-id="ee4e5-132">L'ultima parte dell'URL ("?courseID=2021") è un valore di stringa di query.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-132">The last part of the URL ("?courseID=2021") is a query string value.</span></span> <span data-ttu-id="ee4e5-133">Lo strumento di associazione di modelli passa anche il valore ID al parametro `id` del metodo `Index` se viene passato come un valore di stringa di query:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-133">The model binder will also pass the ID value to the `Index` method `id` parameter if you pass it as a query string value:</span></span>

```
http://localhost:1230/Instructor/Index?id=1&CourseID=2021
```

<span data-ttu-id="ee4e5-134">Nella pagina index gli URL dei collegamenti ipertestuali vengono creati dalle istruzioni di helper tag nella Razor visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-134">In the Index page, hyperlink URLs are created by tag helper statements in the Razor view.</span></span> <span data-ttu-id="ee4e5-135">Nel codice seguente Razor il `id` parametro corrisponde alla route predefinita, quindi `id` viene aggiunto ai dati della route.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-135">In the following Razor code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

```html
<a asp-action="Edit" asp-route-id="@item.ID">Edit</a>
```

<span data-ttu-id="ee4e5-136">Quando `item.ID` è 6, viene generato il codice HTML seguente:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-136">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit/6">Edit</a>
```

<span data-ttu-id="ee4e5-137">Nel codice seguente Razor , `studentID` non corrisponde a un parametro nella route predefinita, quindi viene aggiunto come stringa di query.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-137">In the following Razor code, `studentID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

```html
<a asp-action="Edit" asp-route-studentID="@item.ID">Edit</a>
```

<span data-ttu-id="ee4e5-138">Quando `item.ID` è 6, viene generato il codice HTML seguente:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-138">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit?studentID=6">Edit</a>
```

<span data-ttu-id="ee4e5-139">Per altre informazioni sugli helper tag, vedere <xref:mvc/views/tag-helpers/intro>.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-139">For more information about tag helpers, see <xref:mvc/views/tag-helpers/intro>.</span></span>

### <a name="add-enrollments-to-the-details-view"></a><span data-ttu-id="ee4e5-140">Aggiungere le registrazioni alla visualizzazione Details</span><span class="sxs-lookup"><span data-stu-id="ee4e5-140">Add enrollments to the Details view</span></span>

<span data-ttu-id="ee4e5-141">Aprire *Views/Students/Details.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-141">Open *Views/Students/Details.cshtml*.</span></span> <span data-ttu-id="ee4e5-142">Ogni campo viene visualizzato usando gli helper `DisplayNameFor` e `DisplayFor`, come illustrato nell'esempio seguente:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-142">Each field is displayed using `DisplayNameFor` and `DisplayFor` helpers, as shown in the following example:</span></span>

[!code-cshtml[](intro/samples/cu/Views/Students/Details.cshtml?range=13-18&highlight=2,5)]

<span data-ttu-id="ee4e5-143">Dopo l'ultimo campo e immediatamente prima del tag `</dl>` di chiusura, aggiungere il codice seguente per visualizzare un elenco delle registrazioni:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-143">After the last field and immediately before the closing `</dl>` tag, add the following code to display a list of enrollments:</span></span>

[!code-cshtml[](intro/samples/cu/Views/Students/Details.cshtml?range=31-52)]

<span data-ttu-id="ee4e5-144">Se dopo aver incollato il codice il rientro è errato, premere CTRL-K-D per correggerlo.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-144">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="ee4e5-145">Il codice esegue il ciclo nelle entità nella proprietà di navigazione `Enrollments`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-145">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="ee4e5-146">Per ogni registrazione, il codice visualizza il titolo del corso e il voto.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-146">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="ee4e5-147">Il titolo del corso viene recuperato dall'entità Course memorizzata nella proprietà di navigazione `Course` dell'entità Enrollments.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-147">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="ee4e5-148">Eseguire l'app, selezionare la scheda **Students** e fare clic sul collegamento **Details** relativo a uno studente.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-148">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="ee4e5-149">Viene visualizzato l'elenco dei corsi e dei voti dello studente selezionato:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-149">You see the list of courses and grades for the selected student:</span></span>

![Pagina Details (Student)](crud/_static/student-details.png)

## <a name="update-the-create-page"></a><span data-ttu-id="ee4e5-151">Aggiornare la pagina Create</span><span class="sxs-lookup"><span data-stu-id="ee4e5-151">Update the Create page</span></span>

<span data-ttu-id="ee4e5-152">In *StudentsController.cs* modificare il metodo HttpPost `Create` aggiungendo un blocco Try-Catch e rimuovendo l'ID dall'attributo `Bind`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-152">In *StudentsController.cs*, modify the HttpPost `Create` method by adding a try-catch block and removing ID from the `Bind` attribute.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]

<span data-ttu-id="ee4e5-153">Questo codice aggiunge l'entità Student creata dallo strumento di associazione di modelli di ASP.NET Core MVC al set di entità Students e salva le modifiche nel database.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-153">This code adds the Student entity created by the ASP.NET Core MVC model binder to the Students entity set and then saves the changes to the database.</span></span> <span data-ttu-id="ee4e5-154">Lo strumento di associazione di modelli corrisponde alla funzionalità di ASP.NET Core MVC che rende più semplice l'uso di dati inviati da un modulo; lo strumento di associazione di modelli converte i valori di modulo inviati in tipi CLR e li passa al metodo di azione nei parametri.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-154">(Model binder refers to the ASP.NET Core MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="ee4e5-155">In questo caso lo strumento di associazione di modelli crea automaticamente un'istanza di un'entità Student usando i valori di proprietà della raccolta Form).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-155">In this case, the model binder instantiates a Student entity for you using property values from the Form collection.)</span></span>

<span data-ttu-id="ee4e5-156">`ID` è stato rimosso dall'attributo `Bind` poiché l'ID è il valore di chiave primaria che SQL Server imposta automaticamente quando viene inserita la riga.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-156">You removed `ID` from the `Bind` attribute because ID is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="ee4e5-157">L'input dell'utente non imposta il valore ID.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-157">Input from the user doesn't set the ID value.</span></span>

<span data-ttu-id="ee4e5-158">A differenza dell'attributo `Bind`, il blocco Try-Catch rappresenta l'unica modifica apportata al codice con scaffolding.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-158">Other than the `Bind` attribute, the try-catch block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="ee4e5-159">Se viene rilevata un'eccezione che deriva da `DbUpdateException` durante il salvataggio delle modifiche, viene visualizzato un messaggio di errore generico.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-159">If an exception that derives from `DbUpdateException` is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="ee4e5-160">Poiché le eccezioni `DbUpdateException` sono a volte causate da elementi esterni all'applicazione e non da un errore di programmazione, viene consigliato all'utente di riprovare.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-160">`DbUpdateException` exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="ee4e5-161">Sebbene non sia implementata in questo esempio, un'applicazione di controllo della qualità di produzione potrebbe registrare l'eccezione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-161">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="ee4e5-162">Per altre informazioni, vedere la sezione **Log for insight** (Registrare informazioni dettagliate) in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry) (Monitoraggio e telemetria (creazione di app cloud realistiche con Azure)).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-162">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span></span>

<span data-ttu-id="ee4e5-163">L'attributo `ValidateAntiForgeryToken` è utile per prevenire attacchi tramite richieste intersito false (CSRF).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-163">The `ValidateAntiForgeryToken` attribute helps prevent cross-site request forgery (CSRF) attacks.</span></span> <span data-ttu-id="ee4e5-164">Il token viene inserito automaticamente nella visualizzazione da [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) e viene incluso quando il modulo viene inviato dall'utente.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-164">The token is automatically injected into the view by the [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) and is included when the form is submitted by the user.</span></span> <span data-ttu-id="ee4e5-165">Il token è convalidato dall'attributo `ValidateAntiForgeryToken`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-165">The token is validated by the `ValidateAntiForgeryToken` attribute.</span></span> <span data-ttu-id="ee4e5-166">Per altre informazioni, vedere <xref:security/anti-request-forgery>.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-166">For more information, see <xref:security/anti-request-forgery>.</span></span>

<a id="overpost"></a>

### <a name="security-note-about-overposting"></a><span data-ttu-id="ee4e5-167">Nota sulla sicurezza relativa all'overposting</span><span class="sxs-lookup"><span data-stu-id="ee4e5-167">Security note about overposting</span></span>

<span data-ttu-id="ee4e5-168">L'attributo `Bind` che il codice con scaffolding include nel metodo `Create` consente di impedire l'overposting negli scenari di creazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-168">The `Bind` attribute that the scaffolded code includes on the `Create` method is one way to protect against overposting in create scenarios.</span></span> <span data-ttu-id="ee4e5-169">Si supponga ad esempio che l'entità Student includa una proprietà `Secret` che la pagina Web non deve impostare.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-169">For example, suppose the Student entity includes a `Secret` property that you don't want this web page to set.</span></span>

```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstMidName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Secret { get; set; }
}
```

<span data-ttu-id="ee4e5-170">Anche se non è presente un campo `Secret` nella pagina Web, un hacker potrebbe usare uno strumento come Fiddler oppure scrivere codice JavaScript per inviare un valore di modulo `Secret`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-170">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="ee4e5-171">Senza l'attributo `Bind` che limita i campi usati dallo strumento di associazione di modelli durante la creazione di un'istanza di Student, lo strumento individuerebbe il valore di modulo `Secret` e lo userebbe per creare l'istanza dell'entità Student.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-171">Without the `Bind` attribute limiting the fields that the model binder uses when it creates a Student instance, the model binder would pick up that `Secret` form value and use it to create the Student entity instance.</span></span> <span data-ttu-id="ee4e5-172">Di conseguenza, qualsiasi valore specificato dall'hacker per il campo di modulo `Secret` verrebbe aggiornato nel database.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-172">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="ee4e5-173">L'immagine seguente illustra lo strumento Fiddler che aggiunge il campo `Secret` (con il valore "OverPost") ai valori di modulo inviati.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-173">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Fiddler aggiunge il campo Secret](crud/_static/fiddler.png)

<span data-ttu-id="ee4e5-175">Il valore "OverPost" verrebbe quindi aggiunto alla proprietà `Secret` della riga inserita, sebbene non sia prevista in alcun modo l'impostazione della proprietà da parte della pagina Web.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-175">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

<span data-ttu-id="ee4e5-176">È possibile impedire l'overposting negli scenari di modifica leggendo prima l'entità dal database e quindi chiamando `TryUpdateModel`, passando un elenco delle proprietà consentite esplicito.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-176">You can prevent overposting in edit scenarios by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="ee4e5-177">Questo metodo viene usato in queste esercitazioni.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-177">That's the method used in these tutorials.</span></span>

<span data-ttu-id="ee4e5-178">In alternativa, per impedire l'overposting numerosi sviluppatori usano i modelli di visualizzazione anziché le classi di entità con l'associazione di modelli.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-178">An alternative way to prevent overposting that's preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="ee4e5-179">Includere solo le proprietà da aggiornare nel modello di visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-179">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="ee4e5-180">Al termine delle operazioni eseguite dallo strumento di associazione di modelli di MVC, copiare le proprietà del modello di visualizzazione nell'istanza dell'entità usando facoltativamente uno strumento come AutoMapper.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-180">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as AutoMapper.</span></span> <span data-ttu-id="ee4e5-181">Usare `_context.Entry` nell'istanza dell'entità per impostarne lo stato su `Unchanged` e quindi impostare `Property("PropertyName").IsModified` su true in ogni proprietà dell'entità inclusa nel modello di visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-181">Use `_context.Entry` on the entity instance to set its state to `Unchanged`, and then set `Property("PropertyName").IsModified` to true on each entity property that's included in the view model.</span></span> <span data-ttu-id="ee4e5-182">Questo metodo funziona negli scenari di modifica e negli scenari di creazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-182">This method works in both edit and create scenarios.</span></span>

### <a name="test-the-create-page"></a><span data-ttu-id="ee4e5-183">Testare la pagina Create</span><span class="sxs-lookup"><span data-stu-id="ee4e5-183">Test the Create page</span></span>

<span data-ttu-id="ee4e5-184">Il codice in *views/students/create. cshtml* USA `label` , `input` e `span` (per i messaggi di convalida) gli helper tag per ogni campo.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-184">The code in *Views/Students/Create.cshtml* uses `label`, `input`, and `span` (for validation messages) tag helpers for each field.</span></span>

<span data-ttu-id="ee4e5-185">Eseguire l'app, selezionare la scheda **Students** e fare clic su **Crea nuovo**.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-185">Run the app, select the **Students** tab, and click **Create New**.</span></span>

<span data-ttu-id="ee4e5-186">Immettere i nomi e una data.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-186">Enter names and a date.</span></span> <span data-ttu-id="ee4e5-187">Provare a immettere una data non valida se il browser lo consente.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-187">Try entering an invalid date if your browser lets you do that.</span></span> <span data-ttu-id="ee4e5-188">Alcuni browser forzano l'uso di una selezione data. Fare quindi clic su **Crea** per visualizzare il messaggio di errore.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-188">(Some browsers force you to use a date picker.) Then click **Create** to see the error message.</span></span>

![Errore di convalida della data](crud/_static/date-error.png)

<span data-ttu-id="ee4e5-190">Questa è la convalida lato server che si ottiene per impostazione predefinita; in un'esercitazione successiva viene descritto come aggiungere gli attributi che generano codice anche per la convalida lato client.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-190">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="ee4e5-191">Il codice evidenziato seguente illustra il controllo di convalida del modello nel metodo `Create`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-191">The following highlighted code shows the model validation check in the `Create` method.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]

<span data-ttu-id="ee4e5-192">Modificare la data impostando un valore valido e fare clic su **Crea** per visualizzare il nuovo studente nella pagina **Index**.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-192">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="ee4e5-193">Aggiornare la pagina Edit (Modifica)</span><span class="sxs-lookup"><span data-stu-id="ee4e5-193">Update the Edit page</span></span>

<span data-ttu-id="ee4e5-194">In *StudentController.cs* il metodo HttpGet `Edit`, ovvero il metodo senza l'attributo `HttpPost`, usa il metodo `SingleOrDefaultAsync` per recuperare l'entità Student selezionata, come nel metodo `Details`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-194">In *StudentController.cs*, the HttpGet `Edit` method (the one without the `HttpPost` attribute) uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="ee4e5-195">Non è necessario modificare questo metodo.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-195">You don't need to change this method.</span></span>

### <a name="recommended-httppost-edit-code-read-and-update"></a><span data-ttu-id="ee4e5-196">Codice di modifica HttpPost consigliato: lettura e aggiornamento</span><span class="sxs-lookup"><span data-stu-id="ee4e5-196">Recommended HttpPost Edit code: Read and update</span></span>

<span data-ttu-id="ee4e5-197">Sostituire il metodo di azione HttpPost Edit con il codice seguente.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-197">Replace the HttpPost Edit action method with the following code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]

<span data-ttu-id="ee4e5-198">Queste modifiche implementano una procedura di sicurezza consigliata per impedire l'overposting.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-198">These changes implement a security best practice to prevent overposting.</span></span> <span data-ttu-id="ee4e5-199">Lo scaffolder ha generato un attributo `Bind` e aggiunto l'entità creata dallo strumento di associazione di modelli all'entità impostata con un flag `Modified`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-199">The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a `Modified` flag.</span></span> <span data-ttu-id="ee4e5-200">L'uso di un codice simile non è consigliabile in molti scenari poiché l'attributo `Bind` cancella tutti i dati esistenti nei campi non elencati nel parametro `Include`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-200">That code isn't recommended for many scenarios because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span>

<span data-ttu-id="ee4e5-201">Il nuovo codice legge l'entità esistente e chiama `TryUpdateModel` per aggiornare i campi nell'entità recuperata [in base all'input dell'utente nei dati del modulo inviati](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-201">The new code reads the existing entity and calls `TryUpdateModel` to update fields in the retrieved entity [based on user input in the posted form data](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="ee4e5-202">Il rilevamento modifiche automatico di Entity Framework imposta il flag `Modified` nei campi modificati dall'input del modulo.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-202">The Entity Framework's automatic change tracking sets the `Modified` flag on the fields that are changed by form input.</span></span> <span data-ttu-id="ee4e5-203">Quando viene chiamato il metodo `SaveChanges`, Entity Framework crea le istruzioni SQL per aggiornare la riga del database.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-203">When the `SaveChanges` method is called, the Entity Framework creates SQL statements to update the database row.</span></span> <span data-ttu-id="ee4e5-204">I conflitti di concorrenza vengono ignorati e vengono aggiornate solo le colonne della tabella che sono state aggiornate dall'utente nel database.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-204">Concurrency conflicts are ignored, and only the table columns that were updated by the user are updated in the database.</span></span> <span data-ttu-id="ee4e5-205">(Un'esercitazione successiva illustra come gestire i conflitti di concorrenza).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-205">(A later tutorial shows how to handle concurrency conflicts.)</span></span>

<span data-ttu-id="ee4e5-206">Come procedura consigliata per evitare l'overposting, i campi che si desidera aggiornare dalla pagina di **modifica** vengono dichiarati nei `TryUpdateModel` parametri.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-206">As a best practice to prevent overposting, the fields that you want to be updateable by the **Edit** page are declared in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="ee4e5-207">La stringa vuota che precede l'elenco dei campi nell'elenco di parametri è relativa a un prefisso da usare con i nomi dei campi del modulo. Attualmente non sono presenti campi aggiuntivi da proteggere, ma elencando i campi che si desidera associare allo strumento di associazione di modelli si garantisce che se si aggiungono i campi al modello di dati in futuro, questi ultimi vengono protetti automaticamente finché non vengono aggiunti in modo esplicito.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-207">(The empty string preceding the list of fields in the parameter list is for a prefix to use with the form fields names.) Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="ee4e5-208">In seguito a queste modifiche, la firma del metodo HttpPost `Edit` corrisponde al metodo HttpGet `Edit`. Di conseguenza, il metodo `EditPost` è stato rinominato.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-208">As a result of these changes, the method signature of the HttpPost `Edit` method is the same as the HttpGet `Edit` method; therefore you've renamed the method `EditPost`.</span></span>

### <a name="alternative-httppost-edit-code-create-and-attach"></a><span data-ttu-id="ee4e5-209">Codice di modifica HttpPost alternativo: creazione e collegamento</span><span class="sxs-lookup"><span data-stu-id="ee4e5-209">Alternative HttpPost Edit code: Create and attach</span></span>

<span data-ttu-id="ee4e5-210">Il codice di modifica HttpPost garantisce che vengano aggiornate soltanto le colonne modificate e mantiene i dati nelle proprietà che non si vuole includere per l'associazione di modelli.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-210">The recommended HttpPost edit code ensures that only changed columns get updated and preserves data in properties that you don't want included for model binding.</span></span> <span data-ttu-id="ee4e5-211">Tuttavia, l'approccio con lettura iniziale richiede una lettura del database aggiuntiva e può generare un codice più complesso per la gestione dei conflitti di concorrenza.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-211">However, the read-first approach requires an extra database read, and can result in more complex code for handling concurrency conflicts.</span></span> <span data-ttu-id="ee4e5-212">In alternativa, è possibile collegare un'entità creata dallo strumento di associazione di modelli al contesto EF e contrassegnarla come modificata.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-212">An alternative is to attach an entity created by the model binder to the EF context and mark it as modified.</span></span> <span data-ttu-id="ee4e5-213">(Non aggiornare il progetto con questo codice. Il codice ha il solo scopo di descrivere un approccio facoltativo).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-213">(Don't update your project with this code, it's only shown to illustrate an optional approach.)</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]

<span data-ttu-id="ee4e5-214">È possibile usare questo approccio quando l'interfaccia utente della pagina Web include tutti i campi dell'entità e può aggiornare qualsiasi campo.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-214">You can use this approach when the web page UI includes all of the fields in the entity and can update any of them.</span></span>

<span data-ttu-id="ee4e5-215">Sebbene il codice con scaffolding usi l'approccio che prevede la creazione e il collegamento, il codice rileva solo le eccezioni `DbUpdateConcurrencyException` e restituisce i codici di errore 404.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-215">The scaffolded code uses the create-and-attach approach but only catches `DbUpdateConcurrencyException` exceptions and returns 404 error codes.</span></span>  <span data-ttu-id="ee4e5-216">L'esempio illustrato rileva qualsiasi eccezione di aggiornamento del database e visualizza un messaggio di errore.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-216">The example shown catches any database update exception and displays an error message.</span></span>

### <a name="entity-states"></a><span data-ttu-id="ee4e5-217">Stati di entità</span><span class="sxs-lookup"><span data-stu-id="ee4e5-217">Entity States</span></span>

<span data-ttu-id="ee4e5-218">Il contesto del database rileva se le entità in memoria sono sincronizzate con le righe corrispondenti nel database e queste informazioni determinano le operazioni eseguite quando viene chiamato il metodo `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-218">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="ee4e5-219">Ad esempio, quando una nuova entità viene passata al metodo `Add`, lo stato dell'entità viene impostato su `Added`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-219">For example, when you pass a new entity to the `Add` method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="ee4e5-220">Quando in seguito viene chiamato il metodo `SaveChanges`, il contesto del database esegue un comando SQL INSERT.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-220">Then when you call the `SaveChanges` method, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="ee4e5-221">Le entità possono essere in uno dei seguenti stati:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-221">An entity may be in one of the following states:</span></span>

* <span data-ttu-id="ee4e5-222">`Added`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-222">`Added`.</span></span> <span data-ttu-id="ee4e5-223">L'entità non esiste ancora nel database.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-223">The entity doesn't yet exist in the database.</span></span> <span data-ttu-id="ee4e5-224">Il metodo `SaveChanges` genera un'istruzione INSERT.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-224">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="ee4e5-225">`Unchanged`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-225">`Unchanged`.</span></span> <span data-ttu-id="ee4e5-226">Il metodo `SaveChanges` non deve eseguire alcuna operazione con l'entità.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-226">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="ee4e5-227">Quando un'entità viene letta dal database, l'entità ha inizialmente questo stato.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-227">When you read an entity from the database, the entity starts out with this status.</span></span>

* <span data-ttu-id="ee4e5-228">`Modified`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-228">`Modified`.</span></span> <span data-ttu-id="ee4e5-229">Sono stati modificati alcuni o tutti i valori di proprietà dell'entità.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-229">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="ee4e5-230">Il metodo `SaveChanges` genera un'istruzione UPDATE.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-230">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="ee4e5-231">`Deleted`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-231">`Deleted`.</span></span> <span data-ttu-id="ee4e5-232">L'entità è stata contrassegnata per l'eliminazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-232">The entity has been marked for deletion.</span></span> <span data-ttu-id="ee4e5-233">Il metodo `SaveChanges` genera un'istruzione DELETE.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-233">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="ee4e5-234">`Detached`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-234">`Detached`.</span></span> <span data-ttu-id="ee4e5-235">L'entità non viene registrata dal contesto del database.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-235">The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="ee4e5-236">In un'applicazione desktop le modifiche dello stato vengono in genere impostate automaticamente.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-236">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="ee4e5-237">Viene letta un'entità e vengono apportate modifiche ad alcuni valori delle proprietà.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-237">You read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="ee4e5-238">In questo modo lo stato dell'entità viene modificato automaticamente in `Modified`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-238">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="ee4e5-239">Quando in seguito viene chiamato `SaveChanges`, Entity Framework genera un'istruzione SQL UPDATE che aggiorna solo le proprietà modificate.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-239">Then when you call `SaveChanges`, the Entity Framework generates a SQL UPDATE statement that updates only the actual properties that you changed.</span></span>

<span data-ttu-id="ee4e5-240">In un'app Web il `DbContext` che inizialmente legge un'entità e ne visualizza i dati da modificare viene eliminato dopo il rendering di una pagina.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-240">In a web app, the `DbContext` that initially reads an entity and displays its data to be edited is disposed after a page is rendered.</span></span> <span data-ttu-id="ee4e5-241">Quando viene chiamato il metodo di azione HttpPost `Edit`, viene effettuata una nuova richiesta Web con una nuova istanza di `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-241">When the HttpPost `Edit` action method is called,  a new web request is made and you have a new instance of the `DbContext`.</span></span> <span data-ttu-id="ee4e5-242">La rilettura dell'entità nel nuovo contesto simula l'elaborazione desktop.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-242">If you re-read the entity in that new context, you simulate desktop processing.</span></span>

<span data-ttu-id="ee4e5-243">Tuttavia, se non si vuole eseguire un'operazione di lettura aggiuntiva, è necessario usare l'oggetto dell'entità creato dallo strumento di associazione di modelli.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-243">But if you don't want to do the extra read operation, you have to use the entity object created by the model binder.</span></span>  <span data-ttu-id="ee4e5-244">Il modo più semplice per eseguire questa operazione consiste nell'impostare lo stato dell'entità su Modified, come avviene nel codice di modifica HttpPost alternativo illustrato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-244">The simplest way to do this is to set the entity state to Modified as is done in the alternative HttpPost Edit code shown earlier.</span></span> <span data-ttu-id="ee4e5-245">Quando in seguito viene chiamato `SaveChanges`, Entity Framework aggiorna tutte le colonne della riga di database poiché il contesto non ha la possibilità di individuare le proprietà modificate.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-245">Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>

<span data-ttu-id="ee4e5-246">Se si vuole evitare l'approccio con lettura iniziale e si vuole anche che l'istruzione SQL UPDATE aggiorni solo i campi modificati dall'utente, il codice è più complesso.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-246">If you want to avoid the read-first approach, but you also want the SQL UPDATE statement to update only the fields that the user actually changed, the code is more complex.</span></span> <span data-ttu-id="ee4e5-247">È necessario salvare i valori originali, usando ad esempio campi nascosti, in modo che siano disponibili quando viene chiamato il metodo HttpPost `Edit`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-247">You have to save the original values in some way (such as by using hidden fields) so that they're available when the HttpPost `Edit` method is called.</span></span> <span data-ttu-id="ee4e5-248">Creare quindi un'entità Student usando i valori originali, chiamare il metodo `Attach` con la versione originale dell'entità, aggiornare i valori dell'entità con i nuovi valori e quindi chiamare `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-248">Then you can create a Student entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges`.</span></span>

### <a name="test-the-edit-page"></a><span data-ttu-id="ee4e5-249">Testare la pagina Edit</span><span class="sxs-lookup"><span data-stu-id="ee4e5-249">Test the Edit page</span></span>

<span data-ttu-id="ee4e5-250">Eseguire l'app, selezionare la scheda **Students** e quindi fare clic su un collegamento ipertestuale **Modifica**.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-250">Run the app, select the **Students** tab, then click an **Edit** hyperlink.</span></span>

![Pagina Edit (Students)](crud/_static/student-edit.png)

<span data-ttu-id="ee4e5-252">Modificare alcuni dati e fare clic su **Salva**.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-252">Change some of the data and click **Save**.</span></span> <span data-ttu-id="ee4e5-253">Viene visualizzata la pagina **Index** con i dati modificati.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-253">The **Index** page opens and you see the changed data.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="ee4e5-254">Aggiornare la pagina Delete (Elimina)</span><span class="sxs-lookup"><span data-stu-id="ee4e5-254">Update the Delete page</span></span>

<span data-ttu-id="ee4e5-255">In *StudentController.cs* il codice di modello per il metodo HttpGet `Delete` usa il metodo `SingleOrDefaultAsync` per recuperare l'entità Student selezionata, come descritto per i metodi Details ed Edit.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-255">In *StudentController.cs*, the template code for the HttpGet `Delete` method uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the Details and Edit methods.</span></span> <span data-ttu-id="ee4e5-256">Tuttavia, per implementare un messaggio di errore personalizzato quando la chiamata di `SaveChanges` ha esito negativo, verrà aggiunta una funzionalità al metodo e alla visualizzazione corrispondente.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-256">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="ee4e5-257">Analogamente alle operazioni di aggiornamento e creazione, le operazioni di eliminazione richiedono due metodi di azione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-257">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="ee4e5-258">Il metodo chiamato in risposta a una richiesta GET apre una visualizzazione che offre all'utente la possibilità di approvare o annullare l'operazione di eliminazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-258">The method that's called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="ee4e5-259">Se l'utente approva, viene creata una richiesta POST.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-259">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="ee4e5-260">In questo caso, viene chiamato il metodo HttpPost `Delete` che esegue l'operazione di eliminazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-260">When that happens, the HttpPost `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="ee4e5-261">Si aggiungerà un blocco Try-Catch al metodo HttpPost `Delete` per gestire eventuali errori che possono verificarsi quando viene aggiornato il database.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-261">You'll add a try-catch block to the HttpPost `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="ee4e5-262">Se si verifica un errore, il metodo HttpPost Delete chiama il metodo HttpGet Delete passando un parametro che indica che si è verificato un errore.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-262">If an error occurs, the HttpPost Delete method calls the HttpGet Delete method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="ee4e5-263">Il metodo HttpGet Delete visualizza nuovamente la pagina di conferma con il messaggio di errore offrendo all'utente la possibilità di annullare o ripetere l'operazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-263">The HttpGet Delete method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

<span data-ttu-id="ee4e5-264">Sostituire il metodo di azione HttpGet `Delete` con il codice seguente che gestisce la segnalazione degli errori.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-264">Replace the HttpGet `Delete` action method with the following code, which manages error reporting.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]

<span data-ttu-id="ee4e5-265">Questo codice accetta un parametro facoltativo che indica se il metodo è stato chiamato dopo un errore di salvataggio delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-265">This code accepts an optional parameter that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="ee4e5-266">Il parametro ha valore false quando il metodo HttpGet `Delete` viene chiamato senza essere preceduto da un errore.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-266">This parameter is false when the HttpGet `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="ee4e5-267">Quando viene chiamato dal metodo HttpPost `Delete` in risposta a un errore di aggiornamento del database, il parametro ha valore true e viene passato un messaggio di errore alla visualizzazione.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-267">When it's called by the HttpPost `Delete` method in response to a database update error, the parameter is true and an error message is passed to the view.</span></span>

### <a name="the-read-first-approach-to-httppost-delete"></a><span data-ttu-id="ee4e5-268">Approccio con lettura iniziale per HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="ee4e5-268">The read-first approach to HttpPost Delete</span></span>

<span data-ttu-id="ee4e5-269">Sostituire il metodo di azione HttpPost `Delete` (denominato `DeleteConfirmed`) con il codice seguente che esegue l'operazione di eliminazione e rileva eventuali errori di aggiornamento del database.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-269">Replace the HttpPost `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6-9,11-12,16-21)]

<span data-ttu-id="ee4e5-270">Questo codice recupera l'entità selezionata, quindi chiama il metodo `Remove` per impostare lo stato dell'entità su `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-270">This code retrieves the selected entity, then calls the `Remove` method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="ee4e5-271">Quando viene chiamato `SaveChanges`, viene generato un comando SQL DELETE.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-271">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span>

### <a name="the-create-and-attach-approach-to-httppost-delete"></a><span data-ttu-id="ee4e5-272">Approccio con creazione e collegamento per HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="ee4e5-272">The create-and-attach approach to HttpPost Delete</span></span>

<span data-ttu-id="ee4e5-273">Se il miglioramento delle prestazioni in un'applicazione a volume elevato è una priorità, è possibile evitare una query SQL non necessaria creando un'istanza di un'entità Student usando solo il valore di chiave primaria e impostando lo stato dell'entità su `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-273">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query by instantiating a Student entity using only the primary key value and then setting the entity state to `Deleted`.</span></span> <span data-ttu-id="ee4e5-274">Questo è tutto ciò di cui Entity Framework necessita per eliminare l'entità.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-274">That's all that the Entity Framework needs in order to delete the entity.</span></span> <span data-ttu-id="ee4e5-275">(Non inserire questo codice nel progetto. Il codice ha il solo scopo di descrivere un approccio alternativo).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-275">(Don't put this code in your project; it's here just to illustrate an alternative.)</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]

<span data-ttu-id="ee4e5-276">Se l'entità include anche dati correlati che devono essere eliminati, assicurarsi che sia configurata nel database l'eliminazione a catena.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-276">If the entity has related data that should also be deleted, make sure that cascade delete is configured in the database.</span></span> <span data-ttu-id="ee4e5-277">Con questo approccio per l'eliminazione di entità, EF potrebbe non rilevare le entità correlate da eliminare.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-277">With this approach to entity deletion, EF might not realize there are related entities to be deleted.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="ee4e5-278">Aggiornare la pagina Delete</span><span class="sxs-lookup"><span data-stu-id="ee4e5-278">Update the Delete view</span></span>

<span data-ttu-id="ee4e5-279">In *Views/Student/Delete.cshtml* aggiungere un messaggio di errore tra l'intestazione h2 e l'intestazione h3, come illustrato nell'esempio seguente:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-279">In *Views/Student/Delete.cshtml*, add an error message between the h2 heading and the h3 heading, as shown in the following example:</span></span>

[!code-cshtml[](intro/samples/cu/Views/Students/Delete.cshtml?range=7-9&highlight=2)]

<span data-ttu-id="ee4e5-280">Eseguire l'app, selezionare la scheda **Students** e fare clic sul collegamento ipertestuale **Elimina**:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-280">Run the app, select the **Students** tab, and click a **Delete** hyperlink:</span></span>

![Pagina di conferma dell'eliminazione](crud/_static/student-delete.png)

<span data-ttu-id="ee4e5-282">Fare clic su **Elimina**.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-282">Click **Delete**.</span></span> <span data-ttu-id="ee4e5-283">Viene visualizzata la pagina Index senza lo studente eliminato.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-283">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="ee4e5-284">(L'esercitazione sulla concorrenza include un esempio di codice per la gestione degli errori).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-284">(You'll see an example of the error handling code in action in the concurrency tutorial.)</span></span>

## <a name="close-database-connections"></a><span data-ttu-id="ee4e5-285">Chiudere le connessioni di database</span><span class="sxs-lookup"><span data-stu-id="ee4e5-285">Close database connections</span></span>

<span data-ttu-id="ee4e5-286">Per liberare le risorse di una connessione di database, è necessario eliminare l'istanza del contesto il prima possibile dopo averla usata.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-286">To free up the resources that a database connection holds, the context instance must be disposed as soon as possible when you are done with it.</span></span> <span data-ttu-id="ee4e5-287">L'[inserimento delle dipendenze](../../fundamentals/dependency-injection.md) incorporato di ASP.NET Core esegue automaticamente questa attività.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-287">The ASP.NET Core built-in [dependency injection](../../fundamentals/dependency-injection.md) takes care of that task for you.</span></span>

<span data-ttu-id="ee4e5-288">In *Startup.cs* chiamare il [metodo di estensione AddDbContext](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) per effettuare il provisioning della classe `DbContext` nel contenitore di inserimento delle dipendenze di ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-288">In *Startup.cs*, you call the [AddDbContext extension method](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) to provision the `DbContext` class in the ASP.NET Core DI container.</span></span> <span data-ttu-id="ee4e5-289">Il metodo imposta la durata del servizio su `Scoped` per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-289">That method sets the service lifetime to `Scoped` by default.</span></span> <span data-ttu-id="ee4e5-290">`Scoped` indica che la durata dell'oggetto del contesto corrisponde alla durata della richiesta Web e il metodo `Dispose` viene chiamato automaticamente alla fine della richiesta Web.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-290">`Scoped` means the context object lifetime coincides with the web request life time, and the `Dispose` method will be called automatically at the end of the web request.</span></span>

## <a name="handle-transactions"></a><span data-ttu-id="ee4e5-291">Gestire le transazioni</span><span class="sxs-lookup"><span data-stu-id="ee4e5-291">Handle transactions</span></span>

<span data-ttu-id="ee4e5-292">Per impostazione predefinita Entity Framework implementa in modo implicito le transazioni.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-292">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="ee4e5-293">Negli scenari in cui vengono apportate modifiche a più righe o tabelle e viene quindi chiamato `SaveChanges`, Entity Framework verifica automaticamente che tutte le modifiche siano state apportate o che tutte le modifiche abbiano avuto esito negativo.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-293">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or they all fail.</span></span> <span data-ttu-id="ee4e5-294">Se sono state apportate alcune modifiche e successivamente si verifica un errore, viene automaticamente eseguito il rollback di tali verifiche.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-294">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="ee4e5-295">Per gli scenari in cui è necessario un maggior controllo, ad esempio per includere le operazioni eseguite all'esterno di Entity Framework in una transazione, vedere [Transazioni](/ef/core/saving/transactions).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-295">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Transactions](/ef/core/saving/transactions).</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="ee4e5-296">Query senza registrazione</span><span class="sxs-lookup"><span data-stu-id="ee4e5-296">No-tracking queries</span></span>

<span data-ttu-id="ee4e5-297">Quando un contesto di database recupera righe di tabella e crea oggetti entità che le rappresentano, per impostazione predefinita rileva se le entità in memoria sono sincronizzate con ciò che è presente nel database.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-297">When a database context retrieves table rows and creates entity objects that represent them, by default it keeps track of whether the entities in memory are in sync with what's in the database.</span></span> <span data-ttu-id="ee4e5-298">I dati in memoria svolgono la funzione di una cache e vengono usati per l'aggiornamento di un'entità.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-298">The data in memory acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="ee4e5-299">Questa memorizzazione nella cache spesso non è necessaria in un'applicazione Web poiché le istanze del contesto hanno spesso una durata breve (viene creata ed eliminata una nuova istanza per ogni richiesta) e il contesto che legge un'entità viene in genere eliminato prima che l'entità venga riutilizzata.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-299">This caching is often unnecessary in a web application because context instances are typically short-lived (a new one is created and disposed for each request) and the context that reads an entity is typically disposed before that entity is used again.</span></span>

<span data-ttu-id="ee4e5-300">È possibile disabilitare la registrazione degli oggetti entità in memoria chiamando il metodo `AsNoTracking`.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-300">You can disable tracking of entity objects in memory by calling the `AsNoTracking` method.</span></span> <span data-ttu-id="ee4e5-301">Gli scenari tipici in cui viene disabilitata la registrazione includono i seguenti:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-301">Typical scenarios in which you might want to do that include the following:</span></span>

* <span data-ttu-id="ee4e5-302">Durante la durata del contesto non è necessario eseguire l'aggiornamento di alcuna entità e non è necessario che EF [carichi automaticamente le proprietà di navigazione con entità recuperate da query separate](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-302">During the context lifetime you don't need to update any entities, and you don't need EF to [automatically load navigation properties with  entities retrieved by separate queries](read-related-data.md).</span></span> <span data-ttu-id="ee4e5-303">Queste condizioni si verificano in genere nei metodi di azione HttpGet del controller.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-303">Frequently these conditions are met in a controller's HttpGet action methods.</span></span>

* <span data-ttu-id="ee4e5-304">Si esegue una query che recupera una grande quantità di dati e viene aggiornata solo una piccola quantità dei dati restituiti.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-304">You are running a query that retrieves a large volume of data, and only a small portion of the returned data will be updated.</span></span> <span data-ttu-id="ee4e5-305">Può essere utile disattivare la registrazione per la query ed eseguire successivamente una query per le poche entità che devono essere aggiornate.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-305">It may be more efficient to turn off tracking for the large query, and run a query later for the few entities that need to be updated.</span></span>

* <span data-ttu-id="ee4e5-306">Si vuole collegare un'entità per aggiornarla, ma la stessa entità è stata recuperata in precedenza per uno scopo diverso.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-306">You want to attach an entity in order to update it, but earlier you retrieved the same entity for a different purpose.</span></span> <span data-ttu-id="ee4e5-307">Poiché l'entità viene già registrata dal contesto di database, non è possibile collegare l'entità che si vuole modificare.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-307">Because the entity is already being tracked by the database context, you can't attach the entity that you want to change.</span></span> <span data-ttu-id="ee4e5-308">Un modo per gestire questa situazione consiste nel chiamare `AsNoTracking` nella query precedente.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-308">One way to handle this situation is to call `AsNoTracking` on the earlier query.</span></span>

<span data-ttu-id="ee4e5-309">Per altre informazioni, vedere [Tracking vs. no-tracking](/ef/core/querying/tracking).</span><span class="sxs-lookup"><span data-stu-id="ee4e5-309">For more information, see [Tracking vs. No-Tracking](/ef/core/querying/tracking).</span></span>

## <a name="get-the-code"></a><span data-ttu-id="ee4e5-310">Ottenere il codice</span><span class="sxs-lookup"><span data-stu-id="ee4e5-310">Get the code</span></span>

[<span data-ttu-id="ee4e5-311">Scaricare o visualizzare l'applicazione completata.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-311">Download or view the completed application.</span></span>](https://github.com/dotnet/AspNetCore.Docs/tree/main/aspnetcore/data/ef-mvc/intro/samples/cu-final)

## <a name="next-steps"></a><span data-ttu-id="ee4e5-312">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="ee4e5-312">Next steps</span></span>

<span data-ttu-id="ee4e5-313">In questa esercitazione:</span><span class="sxs-lookup"><span data-stu-id="ee4e5-313">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="ee4e5-314">Personalizzazione della pagina Details</span><span class="sxs-lookup"><span data-stu-id="ee4e5-314">Customized the Details page</span></span>
> * <span data-ttu-id="ee4e5-315">Aggiornamento della pagina Create</span><span class="sxs-lookup"><span data-stu-id="ee4e5-315">Updated the Create page</span></span>
> * <span data-ttu-id="ee4e5-316">Aggiornamento della pagina Edit</span><span class="sxs-lookup"><span data-stu-id="ee4e5-316">Updated the Edit page</span></span>
> * <span data-ttu-id="ee4e5-317">Aggiornamento della pagina Delete</span><span class="sxs-lookup"><span data-stu-id="ee4e5-317">Updated the Delete page</span></span>
> * <span data-ttu-id="ee4e5-318">Chiusura delle connessioni di database</span><span class="sxs-lookup"><span data-stu-id="ee4e5-318">Closed database connections</span></span>

<span data-ttu-id="ee4e5-319">Passare all'esercitazione successiva per informazioni su come estendere la funzionalità della pagina **Index** aggiungendo ordinamento, filtro e suddivisione in pagine.</span><span class="sxs-lookup"><span data-stu-id="ee4e5-319">Advance to the next tutorial to learn how to expand the functionality of the **Index** page by adding sorting, filtering, and paging.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="ee4e5-320">Passaggio successivo: ordinamento, filtro e paging</span><span class="sxs-lookup"><span data-stu-id="ee4e5-320">Next: Sorting, filtering, and paging</span></span>](sort-filter-page.md)
